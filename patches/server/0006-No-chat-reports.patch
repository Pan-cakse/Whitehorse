From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: VidTu <60929459+VidTu@users.noreply.github.com>
Date: Tue, 4 Oct 2022 02:11:52 +0300
Subject: [PATCH] No chat reports

Original code:
<https://github.com/e-im/FreedomChat/blob/main/src/main/java/ru/bk/oharass/freedomchat/FreedomChat.java>
Licensed under GNU General Public License v3.0
<https://github.com/e-im/FreedomChat/blob/main/LICENSE>

diff --git a/src/main/java/net/minecraft/network/chat/OutgoingPlayerChatMessage.java b/src/main/java/net/minecraft/network/chat/OutgoingPlayerChatMessage.java
index d032fce4cf33027c8803b9ab122780eeb831c932..dcc0d66f975ac0975d63df71a246f2d8b86b1ffa 100644
--- a/src/main/java/net/minecraft/network/chat/OutgoingPlayerChatMessage.java
+++ b/src/main/java/net/minecraft/network/chat/OutgoingPlayerChatMessage.java
@@ -14,12 +14,12 @@ public interface OutgoingPlayerChatMessage {
 
     void sendToPlayer(ServerPlayer sender, boolean filterMaskEnabled, ChatType.Bound params);
 
-    // Paper start
-    default void sendToPlayer(ServerPlayer sender, boolean filterMaskEnabled, ChatType.Bound params, @javax.annotation.Nullable Component unsigned) {
-        this.sendToPlayer(sender, filterMaskEnabled, params);
-    }
-    // Paper end
-
+    // Paper start
+    default void sendToPlayer(ServerPlayer sender, boolean filterMaskEnabled, ChatType.Bound params, @javax.annotation.Nullable Component unsigned) {
+        this.sendToPlayer(sender, filterMaskEnabled, params);
+    }
+    // Paper end
+
     void sendHeadersToRemainingPlayers(PlayerList playerManager);
 
     static OutgoingPlayerChatMessage create(PlayerChatMessage message) {
@@ -40,20 +40,27 @@ public interface OutgoingPlayerChatMessage {
 
         @Override
         public void sendToPlayer(ServerPlayer sender, boolean filterMaskEnabled, ChatType.Bound params) {
-            // Paper start
-            this.sendToPlayer(sender, filterMaskEnabled, params, null);
-        }
-
-        @Override
-        public void sendToPlayer(ServerPlayer sender, boolean filterMaskEnabled, ChatType.Bound params, @javax.annotation.Nullable Component unsigned) {
-            // Paper end
+            // Paper start
+            this.sendToPlayer(sender, filterMaskEnabled, params, null);
+        }
+
+        @Override
+        public void sendToPlayer(ServerPlayer sender, boolean filterMaskEnabled, ChatType.Bound params, @javax.annotation.Nullable Component unsigned) {
+            // Paper end
             PlayerChatMessage playerChatMessage = this.message.filter(filterMaskEnabled);
-            playerChatMessage = unsigned != null ? playerChatMessage.withUnsignedContent(unsigned) : playerChatMessage; // Paper
+            playerChatMessage = unsigned != null ? playerChatMessage.withUnsignedContent(unsigned) : playerChatMessage; // Paper
             if (!playerChatMessage.isFullyFiltered()) {
                 RegistryAccess registryAccess = sender.level.registryAccess();
                 ChatType.BoundNetwork boundNetwork = params.toNetwork(registryAccess);
+                // Whitehorse start - no chat reports
+                /*
                 sender.connection.send(new ClientboundPlayerChatPacket(playerChatMessage, boundNetwork));
                 sender.connection.addPendingMessage(playerChatMessage);
+                 */
+                Component content = playerChatMessage.unsignedContent().orElse(playerChatMessage.signedContent().decorated());
+                Component decorated = boundNetwork.resolve(registryAccess).map(c -> c.decorate(content)).orElse(content);
+                sender.connection.send(new net.minecraft.network.protocol.game.ClientboundSystemChatPacket(decorated, false));
+                // Whitehorse end
             }
 
         }
@@ -78,23 +85,30 @@ public interface OutgoingPlayerChatMessage {
 
         @Override
         public void sendToPlayer(ServerPlayer sender, boolean filterMaskEnabled, ChatType.Bound params) {
-            // Paper start
-            this.sendToPlayer(sender, filterMaskEnabled, params, null);
-        }
-
-        @Override
-        public void sendToPlayer(ServerPlayer sender, boolean filterMaskEnabled, ChatType.Bound params, @javax.annotation.Nullable Component unsigned) {
-            // Paper end
+            // Paper start
+            this.sendToPlayer(sender, filterMaskEnabled, params, null);
+        }
+
+        @Override
+        public void sendToPlayer(ServerPlayer sender, boolean filterMaskEnabled, ChatType.Bound params, @javax.annotation.Nullable Component unsigned) {
+            // Paper end
             PlayerChatMessage playerChatMessage = this.message.filter(filterMaskEnabled);
-            playerChatMessage = unsigned != null ? playerChatMessage.withUnsignedContent(unsigned) : playerChatMessage; // Paper
+            playerChatMessage = unsigned != null ? playerChatMessage.withUnsignedContent(unsigned) : playerChatMessage; // Paper
             if (!playerChatMessage.isFullyFiltered()) {
                 this.playersWithFullMessage.add(sender);
                 RegistryAccess registryAccess = sender.level.registryAccess();
                 ChatType.BoundNetwork boundNetwork = params.toNetwork(registryAccess);
+                // Whitehorse start - no chat reports
+                /*
                 sender.connection.send(new ClientboundPlayerChatPacket(playerChatMessage, boundNetwork), PacketSendListener.exceptionallySend(() -> {
                     return new ClientboundPlayerChatHeaderPacket(this.message);
                 }));
                 sender.connection.addPendingMessage(playerChatMessage);
+                 */
+                Component content = playerChatMessage.unsignedContent().orElse(playerChatMessage.signedContent().decorated());
+                Component decorated = boundNetwork.resolve(registryAccess).map(c -> c.decorate(content)).orElse(content);
+                sender.connection.send(new net.minecraft.network.protocol.game.ClientboundSystemChatPacket(decorated, false));
+                // Whitehorse end
             }
 
         }
diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index af7acb628b84539b1ee5ef1934f75f091c4cd91e..a2401aca57425ceb0125b0bb027792a7a65746bc 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -1884,7 +1884,8 @@ public class ServerPlayer extends Player {
 
     public void sendChatHeader(SignedMessageHeader header, MessageSignature headerSignature, byte[] bodyDigest) {
         if (this.acceptsChatMessages()) {
-            this.connection.send(new ClientboundPlayerChatHeaderPacket(header, headerSignature, bodyDigest));
+            // Whitehorse - no chat reports
+            // this.connection.send(new ClientboundPlayerChatHeaderPacket(header, headerSignature, bodyDigest));
         }
 
     }
@@ -1947,7 +1948,7 @@ public class ServerPlayer extends Player {
     }
 
     public void sendServerStatus(ServerStatus metadata) {
-        this.connection.send(new ClientboundServerDataPacket(metadata.getDescription(), metadata.getFavicon(), metadata.previewsChat(), metadata.enforcesSecureChat()));
+        this.connection.send(new ClientboundServerDataPacket(metadata.getDescription(), metadata.getFavicon(), metadata.previewsChat(), true)); // Whitehorse - no chat reports
     }
 
     @Override
